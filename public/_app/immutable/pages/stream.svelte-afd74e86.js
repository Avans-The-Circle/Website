import{S as se,i as ae,s as re,e as i,t as w,k as B,x as le,c as f,a as A,h as y,d as s,m as F,y as oe,b as W,f as ne,g as o,G as c,z as ie,j as Q,r as fe,p as me,C as ce,O as ue,w as de,Q as pe}from"../chunks/index-b9fb2fa5.js";import{C as be,a as x,v as ee,l as _e}from"../chunks/chat-8757c9ac.js";import{U as Ee}from"../chunks/userManager-33287769.js";function Se(n){let m,l,N,b,_,u,h,k,r,E,d,L,D,V,P,O,S,H,a,p,I,g,U,T,q,C,J,j,X,M,v,R,te={canSendMessage:!1};return v=new be({props:te}),n[7](v),{c(){m=i("label"),l=w("View count: "),N=w(n[3]),b=i("br"),_=B(),u=i("label"),h=w("Amount of frames send: "),k=w(n[2]),r=i("br"),E=B(),d=i("label"),L=w("Streaming with "),D=w(n[4]),V=w(" FPS"),P=i("br"),O=B(),S=i("label"),H=w("Confirmed streamer name "),a=w(n[0]),p=i("br"),I=B(),g=i("br"),U=B(),T=i("br"),q=B(),C=i("div"),J=i("div"),j=i("video"),X=B(),M=i("div"),le(v.$$.fragment),this.h()},l(e){m=f(e,"LABEL",{for:!0});var t=A(m);l=y(t,"View count: "),N=y(t,n[3]),t.forEach(s),b=f(e,"BR",{}),_=F(e),u=f(e,"LABEL",{});var K=A(u);h=y(K,"Amount of frames send: "),k=y(K,n[2]),K.forEach(s),r=f(e,"BR",{}),E=F(e),d=f(e,"LABEL",{});var z=A(d);L=y(z,"Streaming with "),D=y(z,n[4]),V=y(z," FPS"),z.forEach(s),P=f(e,"BR",{}),O=F(e),S=f(e,"LABEL",{});var Y=A(S);H=y(Y,"Confirmed streamer name "),a=y(Y,n[0]),Y.forEach(s),p=f(e,"BR",{}),I=F(e),g=f(e,"BR",{}),U=F(e),T=f(e,"BR",{}),q=F(e),C=f(e,"DIV",{class:!0});var G=A(C);J=f(G,"DIV",{class:!0});var Z=A(J);j=f(Z,"VIDEO",{id:!0}),A(j).forEach(s),Z.forEach(s),X=F(G),M=f(G,"DIV",{class:!0,style:!0});var $=A(M);oe(v.$$.fragment,$),$.forEach(s),G.forEach(s),this.h()},h(){W(m,"for","videoStream"),W(j,"id","videoStream"),j.autoplay=!0,W(J,"class","col-8"),W(M,"class","col-4"),ne(M,"padding-left","0"),W(C,"class","row")},m(e,t){o(e,m,t),c(m,l),c(m,N),o(e,b,t),o(e,_,t),o(e,u,t),c(u,h),c(u,k),o(e,r,t),o(e,E,t),o(e,d,t),c(d,L),c(d,D),c(d,V),o(e,P,t),o(e,O,t),o(e,S,t),c(S,H),c(S,a),o(e,p,t),o(e,I,t),o(e,g,t),o(e,U,t),o(e,T,t),o(e,q,t),o(e,C,t),c(C,J),c(J,j),c(C,X),c(C,M),ie(v,M,null),R=!0},p(e,[t]){(!R||t&8)&&Q(N,e[3]),(!R||t&4)&&Q(k,e[2]),(!R||t&16)&&Q(D,e[4]),(!R||t&1)&&Q(a,e[0]);const K={};v.$set(K)},i(e){R||(fe(v.$$.fragment,e),R=!0)},o(e){me(v.$$.fragment,e),R=!1},d(e){e&&s(m),e&&s(b),e&&s(_),e&&s(u),e&&s(r),e&&s(E),e&&s(d),e&&s(P),e&&s(O),e&&s(S),e&&s(p),e&&s(I),e&&s(g),e&&s(U),e&&s(T),e&&s(q),e&&s(C),n[7](null),ce(v)}}}async function Ce(n,m){const l=JSON.stringify(n);let N=new Blob([l]);m.send(N)}function ve(n,m,l){let N=x.pki.privateKeyFromPem(ee.PRIVATE_KEY),b=Math.round(Math.random()*1e4),_="",u,h=0,k=0,r,E,d=!1,L=0,D=new Date().getTime();const V=()=>{!d||(l(6,r=new WebSocket(`${ee.CHATSERVER_URL}`)),l(6,r.onclose=function(a){l(0,_=""),a.wasClean?console.log(`[websocket_close] Connection closed cleanly, code=${a.code} reason=${a.reason}`):console.log("[websocket_close] Connection died"),setTimeout(V,100)},r),l(6,r.onopen=()=>{r.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:b,isStreamer:!0,isChatter:!0})),O()},r),l(6,r.onmessage=function(a){const p=JSON.parse(a.data);switch(p.type){case"CHAT_MESSAGE":u.addChat(p);break;case"SEND_NEXT_FRAME":l(3,k=p.clientCount),O();break;case"CONFIRM_CONNECTION":l(0,_=p.streamId),console.log("Connected streamid",_);break}},r))},P=()=>{const a=document.createElement("canvas");return a.width=E.videoWidth,a.height=E.videoHeight,a.getContext("2d").drawImage(E,0,0),a.toDataURL("image/jpeg")};function O(){const a=P();if(a.length<=10){setTimeout(O,100);return}l(2,h++,h);const p=new Date().getTime();l(4,L=Math.floor(1e3/(p-D)*100)/100),D=p;const I=_e.exports.compress(a);let g=x.md.sha256.create();g.update(I);let U=N.sign(g);const T={type:"STREAM_FRAME",frame:I,frame_timing:new Date().getTime(),frameCounter:h,signature:U};Ce(T,r),console.log(`[${T.frameCounter}]Sending frame: ${T.frame_timing}`)}ue(()=>{d=!1,S()&&r.close()}),de(()=>{d=!0,E=document.querySelector("video"),l(5,b=Ee.getUsername()),navigator.mediaDevices.getUserMedia({video:{width:426,height:240}}).then(a=>E.srcObject=a),V()});function S(){return!(r===void 0||r.readyState!==WebSocket.OPEN)}function H(a){pe[a?"unshift":"push"](()=>{u=a,l(1,u)})}return n.$$.update=()=>{n.$$.dirty&97&&S()&&_!==b&&r.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:b,isStreamer:!0,isChatter:!0}))},[_,u,h,k,L,b,r,H]}class he extends se{constructor(m){super(),ae(this,m,ve,Se,re,{})}}export{he as default};
