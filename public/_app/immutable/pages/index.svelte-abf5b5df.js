import{S as Y,i as j,s as Q,e as k,t as R,k as L,c as S,a as w,h as K,d as h,m as P,b as N,f as $,g as A,G as g,j as ee,n as C,w as te,K as se,L as X,M as ae,o as ne,p as M,q as re,r as T,N as le,O as oe,P as ce,Q as U,x as W,y as B,z as H,C as G,R as ie,T as ue}from"../chunks/index-7f5e128c.js";import{l as fe,a as J,v as z,C as de}from"../chunks/chat-3c89cb3a.js";function _e(o){let e,t,n,i,c,r,a,s;return{c(){e=k("div"),t=k("label"),n=R("View count: "),i=R(o[0]),c=L(),r=k("br"),a=L(),s=k("canvas"),this.h()},l(f){e=S(f,"DIV",{class:!0,style:!0});var u=w(e);t=S(u,"LABEL",{for:!0});var p=w(t);n=K(p,"View count: "),i=K(p,o[0]),p.forEach(h),c=P(u),r=S(u,"BR",{}),a=P(u),s=S(u,"CANVAS",{id:!0,style:!0}),w(s).forEach(h),u.forEach(h),this.h()},h(){N(t,"for","canvas-"+o[1]),N(s,"id","canvas-"+o[1]),$(s,"max-width","100%"),$(s,"max-height","100%"),$(s,"width","100%"),N(e,"class","bg-warning position-relative"),$(e,"height","100%"),$(e,"width","100%")},m(f,u){A(f,e,u),g(e,t),g(t,n),g(t,i),g(e,c),g(e,r),g(e,a),g(e,s)},p(f,[u]){u&1&&ee(i,f[0])},i:C,o:C,d(f){f&&h(e)}}}function me(o,e,t){const n=Math.round(Math.random()*1e10);let{clientCount:i=0}=e,c,r;te(()=>{r=document.getElementById(`canvas-${n}`),c=r.getContext("2d")});function a(f){const u=new Image;u.onload=function(){r.width=u.naturalWidth,r.height=u.naturalHeight,c.drawImage(u,0,0)},u.src=fe.exports.decompress(f)}function s(){c.fillStyle="rgb(255, 255, 255)",c.fillRect(0,0,r.width,r.height)}return o.$$set=f=>{"clientCount"in f&&t(0,i=f.clientCount)},[i,n,a,s]}class he extends Y{constructor(e){super(),j(this,e,me,_e,Q,{clientCount:0,processStream:2,clearStream:3})}get processStream(){return this.$$.ctx[2]}get clearStream(){return this.$$.ctx[3]}}function Z(o,e,t){const n=o.slice();return n[17]=e[t],n}function x(o){let e,t,n=o[17]+"",i,c;return{c(){e=k("option"),t=R("Streamer "),i=R(n),this.h()},l(r){e=S(r,"OPTION",{});var a=w(e);t=K(a,"Streamer "),i=K(a,n),a.forEach(h),this.h()},h(){e.__value=c=o[17],e.value=e.__value},m(r,a){A(r,e,a),g(e,t),g(e,i)},p(r,a){a&32&&n!==(n=r[17]+"")&&ee(i,n),a&32&&c!==(c=r[17])&&(e.__value=c,e.value=e.__value)},d(r){r&&h(e)}}}function ge(o){let e,t,n,i,c,r,a;const s=[Ce,be],f=[];function u(l,d){return l[0]==="-1"?0:1}t=u(o),n=f[t]=s[t](o);let p={};return r=new de({props:p}),o[11](r),r.$on("sendChatMessage",o[6]),{c(){e=k("div"),n.c(),i=L(),c=k("div"),W(r.$$.fragment),this.h()},l(l){e=S(l,"DIV",{class:!0,style:!0});var d=w(e);n.l(d),d.forEach(h),i=P(l),c=S(l,"DIV",{class:!0,style:!0});var v=w(c);B(r.$$.fragment,v),v.forEach(h),this.h()},h(){N(e,"class","col-8"),$(e,"padding-right","0"),N(c,"class","col-4"),$(c,"padding-left","0")},m(l,d){A(l,e,d),f[t].m(e,null),A(l,i,d),A(l,c,d),H(r,c,null),a=!0},p(l,d){let v=t;t=u(l),t===v?f[t].p(l,d):(ne(),M(f[v],1,1,()=>{f[v]=null}),re(),n=f[t],n?n.p(l,d):(n=f[t]=s[t](l),n.c()),T(n,1),n.m(e,null));const b={};r.$set(b)},i(l){a||(T(n),T(r.$$.fragment,l),a=!0)},o(l){M(n),M(r.$$.fragment,l),a=!1},d(l){l&&h(e),f[t].d(),l&&h(i),l&&h(c),o[11](null),G(r)}}}function pe(o){let e,t;return{c(){e=k("h1"),t=R("Disconnected...")},l(n){e=S(n,"H1",{});var i=w(e);t=K(i,"Disconnected..."),i.forEach(h)},m(n,i){A(n,e,i),g(e,t)},p:C,i:C,o:C,d(n){n&&h(e)}}}function ve(o){let e,t;return{c(){e=k("h1"),t=R("Socket disconnected")},l(n){e=S(n,"H1",{});var i=w(e);t=K(i,"Socket disconnected"),i.forEach(h)},m(n,i){A(n,e,i),g(e,t)},p:C,i:C,o:C,d(n){n&&h(e)}}}function be(o){let e,t,n;function i(r){o[9](r)}let c={};return o[4]!==void 0&&(c.clientCount=o[4]),e=new he({props:c}),U.push(()=>ie(e,"clientCount",i)),o[10](e),{c(){W(e.$$.fragment)},l(r){B(e.$$.fragment,r)},m(r,a){H(e,r,a),n=!0},p(r,a){const s={};!t&&a&16&&(t=!0,s.clientCount=r[4],ue(()=>t=!1)),e.$set(s)},i(r){n||(T(e.$$.fragment,r),n=!0)},o(r){M(e.$$.fragment,r),n=!1},d(r){o[10](null),G(e,r)}}}function Ce(o){return{c:C,l:C,m:C,p:C,i:C,o:C,d:C}}function ke(o){let e,t,n,i,c,r,a,s,f,u,p,l=o[5],d=[];for(let m=0;m<l.length;m+=1)d[m]=x(Z(o,l,m));const v=[ve,pe,ge],b=[];function F(m,y){return m[1]===void 0||m[1].readyState!==WebSocket.OPEN?0:m[0]==="-1"?1:2}return a=F(o),s=b[a]=v[a](o),{c(){e=k("div"),t=k("select"),n=k("option"),i=R("Disconnected");for(let m=0;m<d.length;m+=1)d[m].c();c=L(),r=k("div"),s.c(),this.h()},l(m){e=S(m,"DIV",{class:!0,style:!0});var y=w(e);t=S(y,"SELECT",{class:!0,"aria-label":!0});var I=w(t);n=S(I,"OPTION",{});var _=w(n);i=K(_,"Disconnected"),_.forEach(h);for(let O=0;O<d.length;O+=1)d[O].l(I);I.forEach(h),c=P(y),r=S(y,"DIV",{class:!0,style:!0});var E=w(r);s.l(E),E.forEach(h),y.forEach(h),this.h()},h(){n.__value="-1",n.value=n.__value,N(t,"class","form-select"),N(t,"aria-label","Please select a stream..."),o[0]===void 0&&se(()=>o[8].call(t)),N(r,"class","row"),$(r,"height","calc(100% - 2.4rem)"),N(e,"class","col"),$(e,"height","calc(49vh - 1.5rem)"),$(e,"padding","0")},m(m,y){A(m,e,y),g(e,t),g(t,n),g(n,i);for(let I=0;I<d.length;I+=1)d[I].m(t,null);X(t,o[0]),g(e,c),g(e,r),b[a].m(r,null),f=!0,u||(p=ae(t,"change",o[8]),u=!0)},p(m,[y]){if(y&32){l=m[5];let _;for(_=0;_<l.length;_+=1){const E=Z(m,l,_);d[_]?d[_].p(E,y):(d[_]=x(E),d[_].c(),d[_].m(t,null))}for(;_<d.length;_+=1)d[_].d(1);d.length=l.length}y&33&&X(t,m[0]);let I=a;a=F(m),a===I?b[a].p(m,y):(ne(),M(b[I],1,1,()=>{b[I]=null}),re(),s=b[a],s?s.p(m,y):(s=b[a]=v[a](m),s.c()),T(s,1),s.m(r,null))},i(m){f||(T(s),f=!0)},o(m){M(s),f=!1},d(m){m&&h(e),le(d,m),b[a].d(),u=!1,p()}}}function Se(o,e,t){let n=J.pki.privateKeyFromPem(z.PRIVATE_KEY),i=J.pki.publicKeyFromPem(z.PUBLIC_KEY),c=0,r="-1",a="",s,f,u,p=!1,l=[];function d(){return!(s===void 0||s.readyState!==WebSocket.OPEN)}const v=()=>{if(!p)return;t(1,s=new WebSocket(`${z.CHATSERVER_URL}`)),t(1,s.onopen=()=>{console.log("[websocket_opened]"),s.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:r,isWatcher:!0,isChatter:!0}))},s),t(1,s.onclose=function(V){t(7,a=""),V.wasClean?console.log(`[websocket_close] Connection closed cleanly, code=${V.code} reason=${V.reason}`):console.log("[websocket_close] Connection died"),setTimeout(v,100)},s),t(1,s.onerror=function(V){console.error(`[websocket_error] ${V.message}`)},s);let _,E,O;t(1,s.onmessage=function(V){const D=JSON.parse(V.data);switch(console.log("[Socket]Incomming:",D.type),D.type){case"CHAT_MESSAGE":_=J.md.sha256.create(),_.update(D.message,"utf8"),E=D.signature,O=i.verify(_.digest().bytes(),E),O&&u.addChat(D);break;case"AVAILABLE_CLIENTS":t(5,l=D.streamerList),console.log("streamerList:",l);break;case"INCOMMING_STREAM":t(4,c=D.clientCount),_=J.md.sha256.create(),_.update(D.frame),E=D.signature,O=i.verify(_.digest().bytes(),E),O&&f.processStream(D.frame);break;case"CONFIRM_CONNECTION":t(7,a=D.streamId);break}},s)};oe(()=>{p=!1,d()&&s.close()}),te(()=>{p=!0,v()});async function b(_){const E=_.detail;if(console.log("Sending message: ",E),E==="")return;if(!d()){console.error("Websocket not connected.",s),alert("Chat server connection issue. Check console for more info.");return}let O=J.md.sha256.create();O.update(E,"utf8");let V=n.sign(O);s.send(JSON.stringify({type:"SEND_MESSAGE",sender:"Chatter",message:E,signature:V}))}function F(){r=ce(this),t(0,r),t(5,l)}function m(_){c=_,t(4,c)}function y(_){U[_?"unshift":"push"](()=>{f=_,t(2,f)})}function I(_){U[_?"unshift":"push"](()=>{u=_,t(3,u)})}return o.$$.update=()=>{o.$$.dirty&143&&d()&&a!==r&&(s.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:r,isWatcher:!0,isChatter:!0})),u&&u.clearChatMessages!==void 0&&u.clearChatMessages(),f&&f.clearStream!==void 0&&f.clearStream())},[r,s,f,u,c,l,b,a,F,m,y,I]}class q extends Y{constructor(e){super(),j(this,e,Se,ke,Q,{})}}function ye(o){let e,t,n,i,c,r,a,s,f,u,p;return n=new q({}),c=new q({}),s=new q({}),u=new q({}),{c(){e=k("div"),t=k("div"),W(n.$$.fragment),i=L(),W(c.$$.fragment),r=L(),a=k("div"),W(s.$$.fragment),f=L(),W(u.$$.fragment),this.h()},l(l){e=S(l,"DIV",{class:!0,style:!0});var d=w(e);t=S(d,"DIV",{class:!0,style:!0});var v=w(t);B(n.$$.fragment,v),i=P(v),B(c.$$.fragment,v),v.forEach(h),r=P(d),a=S(d,"DIV",{class:!0,style:!0});var b=w(a);B(s.$$.fragment,b),f=P(b),B(u.$$.fragment,b),b.forEach(h),d.forEach(h),this.h()},h(){N(t,"class","row"),$(t,"padding","0"),$(t,"margin","0"),N(a,"class","row"),$(a,"padding","0"),$(a,"margin","0"),N(e,"class","row"),$(e,"margin","0")},m(l,d){A(l,e,d),g(e,t),H(n,t,null),g(t,i),H(c,t,null),g(e,r),g(e,a),H(s,a,null),g(a,f),H(u,a,null),p=!0},p:C,i(l){p||(T(n.$$.fragment,l),T(c.$$.fragment,l),T(s.$$.fragment,l),T(u.$$.fragment,l),p=!0)},o(l){M(n.$$.fragment,l),M(c.$$.fragment,l),M(s.$$.fragment,l),M(u.$$.fragment,l),p=!1},d(l){l&&h(e),G(n),G(c),G(s),G(u)}}}class we extends Y{constructor(e){super(),j(this,e,null,ye,Q,{})}}export{we as default};
