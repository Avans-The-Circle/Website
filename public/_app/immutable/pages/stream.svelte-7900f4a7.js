import{S as de,i as pe,s as _e,e as f,t as C,k as I,x as be,c as m,a as y,h as w,d as s,m as g,y as Ee,b as F,f as Se,g as i,G as u,U as fe,z as ve,M as Ce,j as ee,r as ye,p as we,C as Ne,O as he,w as Oe,Q as Te}from"../chunks/index-7f5e128c.js";import{C as Ie,a as me,v as ue,l as ge}from"../chunks/chat-4571303b.js";import"../chunks/_commonjsHelpers-15fb5e92.js";function De(n){let d,l,L,b,c,N,p,J,o,S,D,v,j,M,U,A,E,q,H,z,a,r,_,R,k,h,P,G,Y,Q,X,O,K,W,te,V,T,B,se,re,ce={canSendMessage:!1};return T=new Ie({props:ce}),n[8](T),{c(){d=f("div"),l=f("label"),L=C("Enter your streamer name:"),b=I(),c=f("input"),N=I(),p=f("label"),J=C("View count: "),o=C(n[4]),S=f("br"),D=I(),v=f("label"),j=C("Amount of frames send: "),M=C(n[3]),U=f("br"),A=I(),E=f("label"),q=C("Streaming with "),H=C(n[5]),z=C(" FPS"),a=f("br"),r=I(),_=f("label"),R=C("Confirmed streamer name "),k=C(n[1]),h=f("br"),P=I(),G=f("br"),Y=I(),Q=f("br"),X=I(),O=f("div"),K=f("div"),W=f("video"),te=I(),V=f("div"),be(T.$$.fragment),this.h()},l(e){d=m(e,"DIV",{});var t=y(d);l=m(t,"LABEL",{for:!0});var Z=y(l);L=w(Z,"Enter your streamer name:"),Z.forEach(s),b=g(t),c=m(t,"INPUT",{id:!0,type:!0}),t.forEach(s),N=g(e),p=m(e,"LABEL",{for:!0});var ae=y(p);J=w(ae,"View count: "),o=w(ae,n[4]),ae.forEach(s),S=m(e,"BR",{}),D=g(e),v=m(e,"LABEL",{});var le=y(v);j=w(le,"Amount of frames send: "),M=w(le,n[3]),le.forEach(s),U=m(e,"BR",{}),A=g(e),E=m(e,"LABEL",{});var $=y(E);q=w($,"Streaming with "),H=w($,n[5]),z=w($," FPS"),$.forEach(s),a=m(e,"BR",{}),r=g(e),_=m(e,"LABEL",{});var oe=y(_);R=w(oe,"Confirmed streamer name "),k=w(oe,n[1]),oe.forEach(s),h=m(e,"BR",{}),P=g(e),G=m(e,"BR",{}),Y=g(e),Q=m(e,"BR",{}),X=g(e),O=m(e,"DIV",{class:!0});var x=y(O);K=m(x,"DIV",{class:!0});var ie=y(K);W=m(ie,"VIDEO",{id:!0}),y(W).forEach(s),ie.forEach(s),te=g(x),V=m(x,"DIV",{class:!0,style:!0});var ne=y(V);Ee(T.$$.fragment,ne),ne.forEach(s),x.forEach(s),this.h()},h(){F(l,"for","streamId"),F(c,"id","streamId"),F(c,"type","text"),F(p,"for","videoStream"),F(W,"id","videoStream"),W.autoplay=!0,F(K,"class","col-8"),F(V,"class","col-4"),Se(V,"padding-left","0"),F(O,"class","row")},m(e,t){i(e,d,t),u(d,l),u(l,L),u(d,b),u(d,c),fe(c,n[0]),i(e,N,t),i(e,p,t),u(p,J),u(p,o),i(e,S,t),i(e,D,t),i(e,v,t),u(v,j),u(v,M),i(e,U,t),i(e,A,t),i(e,E,t),u(E,q),u(E,H),u(E,z),i(e,a,t),i(e,r,t),i(e,_,t),u(_,R),u(_,k),i(e,h,t),i(e,P,t),i(e,G,t),i(e,Y,t),i(e,Q,t),i(e,X,t),i(e,O,t),u(O,K),u(K,W),u(O,te),u(O,V),ve(T,V,null),B=!0,se||(re=Ce(c,"input",n[7]),se=!0)},p(e,[t]){t&1&&c.value!==e[0]&&fe(c,e[0]),(!B||t&16)&&ee(o,e[4]),(!B||t&8)&&ee(M,e[3]),(!B||t&32)&&ee(H,e[5]),(!B||t&2)&&ee(k,e[1]);const Z={};T.$set(Z)},i(e){B||(ye(T.$$.fragment,e),B=!0)},o(e){we(T.$$.fragment,e),B=!1},d(e){e&&s(d),e&&s(N),e&&s(p),e&&s(S),e&&s(D),e&&s(v),e&&s(U),e&&s(A),e&&s(E),e&&s(a),e&&s(r),e&&s(_),e&&s(h),e&&s(P),e&&s(G),e&&s(Y),e&&s(Q),e&&s(X),e&&s(O),n[8](null),Ne(T),se=!1,re()}}}async function Ae(n,d){const l=JSON.stringify(n);let L=new Blob([l]);d.send(L)}function Re(n,d,l){let L=me.pki.privateKeyFromPem(ue.PRIVATE_KEY),b="1",c="",N,p=0,J=0,o,S,D=!1,v=0,j=new Date().getTime();const M=()=>{!D||(l(6,o=new WebSocket(`${ue.CHATSERVER_URL}`)),l(6,o.onclose=function(a){l(1,c=""),a.wasClean?console.log(`[websocket_close] Connection closed cleanly, code=${a.code} reason=${a.reason}`):console.log("[websocket_close] Connection died"),setTimeout(M,100)},o),l(6,o.onopen=()=>{o.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:b,isStreamer:!0,isChatter:!0})),A()},o),l(6,o.onmessage=function(a){const r=JSON.parse(a.data);switch(r.type){case"CHAT_MESSAGE":N.addChat(r);break;case"SEND_NEXT_FRAME":l(4,J=r.clientCount),A();break;case"CONFIRM_CONNECTION":l(1,c=r.streamId),console.log("Connected streamid",c);break}},o))},U=()=>{const a=document.createElement("canvas");return a.width=S.videoWidth,a.height=S.videoHeight,a.getContext("2d").drawImage(S,0,0),a.toDataURL("image/jpeg")};function A(){const a=U();if(a.length<=10){setTimeout(A,100);return}l(3,p++,p);const r=new Date().getTime();l(5,v=Math.floor(1e3/(r-j)*100)/100),j=r;const _=ge.exports.compress(a);let R=me.md.sha256.create();R.update(_),console.log(a),q(a);let k=L.sign(R);const h={type:"STREAM_FRAME",frame:_,frame_timing:new Date().getTime(),frameCounter:p,signature:k};Ae(h,o),console.log(`[${h.frameCounter}]Sending frame: ${h.frame_timing}`)}he(()=>{D=!1,E()&&o.close()}),Oe(()=>{D=!0,S=document.querySelector("video"),navigator.mediaDevices.getUserMedia({video:{width:426,height:240}}).then(a=>S.srcObject=a),M()});function E(){return!(o===void 0||o.readyState!==WebSocket.OPEN)}async function q(a){var r=new Date,_=r.getFullYear()+"-"+(r.getMonth()+1)+"-"+r.getDate(),R=r.getHours()+":"+r.getMinutes()+":"+r.getSeconds(),k=_+" "+R;const P=await(await fetch("http://localhost:8050/api/stream",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({stream:"Stream "+b,base64:a,timestamp:k})})).json();console.log(P),JSON.stringify(P)}function H(){b=this.value,l(0,b)}function z(a){Te[a?"unshift":"push"](()=>{N=a,l(2,N)})}return n.$$.update=()=>{n.$$.dirty&67&&E()&&c!==b&&o.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:b,isStreamer:!0,isChatter:!0}))},[b,c,N,p,J,v,o,H,z]}class Le extends de{constructor(d){super(),pe(this,d,Re,De,_e,{})}}export{Le as default};
