import{S as pe,i as de,s as _e,e as n,t as C,k as T,x as be,c as f,a as y,h as N,d as s,m as h,y as Ee,b as B,f as ve,g as o,G as m,U as fe,z as Se,M as Ce,j as ee,r as ye,p as Ne,C as we,O as Ie,w as Oe,Q as Te}from"../chunks/index-7f5e128c.js";import{C as he,a as me,v as ue,l as Ae}from"../chunks/chat-3c89cb3a.js";function Re(i){let c,a,L,b,u,w,p,P,r,E,A,v,g,F,J,R,_,K,U,l,d,M,S,W,D,q,z,G,Q,X,Y,I,j,H,te,V,O,k,se,oe,ce={canSendMessage:!1};return O=new he({props:ce}),i[8](O),{c(){c=n("div"),a=n("label"),L=C("Enter your streamer name:"),b=T(),u=n("input"),w=T(),p=n("label"),P=C("View count: "),r=C(i[4]),E=n("br"),A=T(),v=n("label"),g=C("Amount of frames send: "),F=C(i[3]),J=n("br"),R=T(),_=n("label"),K=C("Streaming with "),U=C(i[5]),l=C(" FPS"),d=n("br"),M=T(),S=n("label"),W=C("Confirmed streamer name "),D=C(i[1]),q=n("br"),z=T(),G=n("br"),Q=T(),X=n("br"),Y=T(),I=n("div"),j=n("div"),H=n("video"),te=T(),V=n("div"),be(O.$$.fragment),this.h()},l(e){c=f(e,"DIV",{});var t=y(c);a=f(t,"LABEL",{for:!0});var Z=y(a);L=N(Z,"Enter your streamer name:"),Z.forEach(s),b=h(t),u=f(t,"INPUT",{id:!0,type:!0}),t.forEach(s),w=h(e),p=f(e,"LABEL",{for:!0});var le=y(p);P=N(le,"View count: "),r=N(le,i[4]),le.forEach(s),E=f(e,"BR",{}),A=h(e),v=f(e,"LABEL",{});var ae=y(v);g=N(ae,"Amount of frames send: "),F=N(ae,i[3]),ae.forEach(s),J=f(e,"BR",{}),R=h(e),_=f(e,"LABEL",{});var $=y(_);K=N($,"Streaming with "),U=N($,i[5]),l=N($," FPS"),$.forEach(s),d=f(e,"BR",{}),M=h(e),S=f(e,"LABEL",{});var re=y(S);W=N(re,"Confirmed streamer name "),D=N(re,i[1]),re.forEach(s),q=f(e,"BR",{}),z=h(e),G=f(e,"BR",{}),Q=h(e),X=f(e,"BR",{}),Y=h(e),I=f(e,"DIV",{class:!0});var x=y(I);j=f(x,"DIV",{class:!0});var ie=y(j);H=f(ie,"VIDEO",{id:!0}),y(H).forEach(s),ie.forEach(s),te=h(x),V=f(x,"DIV",{class:!0,style:!0});var ne=y(V);Ee(O.$$.fragment,ne),ne.forEach(s),x.forEach(s),this.h()},h(){B(a,"for","streamId"),B(u,"id","streamId"),B(u,"type","text"),B(p,"for","videoStream"),B(H,"id","videoStream"),H.autoplay=!0,B(j,"class","col-8"),B(V,"class","col-4"),ve(V,"padding-left","0"),B(I,"class","row")},m(e,t){o(e,c,t),m(c,a),m(a,L),m(c,b),m(c,u),fe(u,i[0]),o(e,w,t),o(e,p,t),m(p,P),m(p,r),o(e,E,t),o(e,A,t),o(e,v,t),m(v,g),m(v,F),o(e,J,t),o(e,R,t),o(e,_,t),m(_,K),m(_,U),m(_,l),o(e,d,t),o(e,M,t),o(e,S,t),m(S,W),m(S,D),o(e,q,t),o(e,z,t),o(e,G,t),o(e,Q,t),o(e,X,t),o(e,Y,t),o(e,I,t),m(I,j),m(j,H),m(I,te),m(I,V),Se(O,V,null),k=!0,se||(oe=Ce(u,"input",i[7]),se=!0)},p(e,[t]){t&1&&u.value!==e[0]&&fe(u,e[0]),(!k||t&16)&&ee(r,e[4]),(!k||t&8)&&ee(F,e[3]),(!k||t&32)&&ee(U,e[5]),(!k||t&2)&&ee(D,e[1]);const Z={};O.$set(Z)},i(e){k||(ye(O.$$.fragment,e),k=!0)},o(e){Ne(O.$$.fragment,e),k=!1},d(e){e&&s(c),e&&s(w),e&&s(p),e&&s(E),e&&s(A),e&&s(v),e&&s(J),e&&s(R),e&&s(_),e&&s(d),e&&s(M),e&&s(S),e&&s(q),e&&s(z),e&&s(G),e&&s(Q),e&&s(X),e&&s(Y),e&&s(I),i[8](null),we(O),se=!1,oe()}}}async function De(i,c){const a=JSON.stringify(i);let L=new Blob([a]);c.send(L)}function ke(i,c,a){let L=me.pki.privateKeyFromPem(ue.PRIVATE_KEY),b="1",u="",w,p=0,P=0,r,E,A=!1,v=0,g=new Date().getTime();const F=()=>{!A||(a(6,r=new WebSocket(`${ue.CHATSERVER_URL}`)),a(6,r.onclose=function(l){a(1,u=""),l.wasClean?console.log(`[websocket_close] Connection closed cleanly, code=${l.code} reason=${l.reason}`):console.log("[websocket_close] Connection died"),setTimeout(F,100)},r),a(6,r.onopen=()=>{r.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:b,isStreamer:!0,isChatter:!0})),R()},r),a(6,r.onmessage=function(l){const d=JSON.parse(l.data);switch(d.type){case"CHAT_MESSAGE":w.addChat(d);break;case"SEND_NEXT_FRAME":a(4,P=d.clientCount),R();break;case"CONFIRM_CONNECTION":a(1,u=d.streamId),console.log("Connected streamid",u);break}},r))},J=()=>{const l=document.createElement("canvas");return l.width=E.videoWidth,l.height=E.videoHeight,l.getContext("2d").drawImage(E,0,0),l.toDataURL("image/jpeg")};function R(){const l=J();if(l.length<=10){setTimeout(R,100);return}a(3,p++,p);const d=new Date().getTime();a(5,v=Math.floor(1e3/(d-g)*100)/100),g=d;const M=Ae.exports.compress(l);let S=me.md.sha256.create();S.update(M),console.log(l);let W=L.sign(S);const D={type:"STREAM_FRAME",frame:M,frame_timing:new Date().getTime(),frameCounter:p,signature:W};De(D,r),console.log(`[${D.frameCounter}]Sending frame: ${D.frame_timing}`)}Ie(()=>{A=!1,_()&&r.close()}),Oe(()=>{A=!0,E=document.querySelector("video"),navigator.mediaDevices.getUserMedia({video:{width:426,height:240}}).then(l=>E.srcObject=l),F()});function _(){return!(r===void 0||r.readyState!==WebSocket.OPEN)}function K(){b=this.value,a(0,b)}function U(l){Te[l?"unshift":"push"](()=>{w=l,a(2,w)})}return i.$$.update=()=>{i.$$.dirty&67&&_()&&u!==b&&r.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:b,isStreamer:!0,isChatter:!0}))},[b,u,w,p,P,v,r,K,U]}class Fe extends pe{constructor(c){super(),de(this,c,ke,Re,_e,{})}}export{Fe as default};
