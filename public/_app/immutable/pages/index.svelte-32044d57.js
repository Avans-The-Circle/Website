import{S as j,i as Q,s as X,e as b,t as W,k as P,c as C,a as $,h as H,d as h,m as R,b as I,f as E,g as V,G as g,j as ne,n as A,w as re,L as le,M as Z,H as oe,o as se,p as D,q as ae,r as M,N as ie,O as ce,P as ue,Q as Y,x as K,y as B,z as U,R as fe,C as G,T as de}from"../chunks/index-b9fb2fa5.js";import{l as me,a as J,v as z,C as he}from"../chunks/chat-8757c9ac.js";import{U as _e}from"../chunks/userManager-33287769.js";function ge(o){let e,n,s,l,u,t,a,r;return{c(){e=b("div"),n=b("label"),s=W("View count: "),l=W(o[0]),u=P(),t=b("br"),a=P(),r=b("canvas"),this.h()},l(c){e=C(c,"DIV",{class:!0,style:!0});var i=$(e);n=C(i,"LABEL",{for:!0});var S=$(n);s=H(S,"View count: "),l=H(S,o[0]),S.forEach(h),u=R(i),t=C(i,"BR",{}),a=R(i),r=C(i,"CANVAS",{id:!0,style:!0}),$(r).forEach(h),i.forEach(h),this.h()},h(){I(n,"for","canvas-"+o[1]),I(r,"id","canvas-"+o[1]),E(r,"max-width","100%"),E(r,"max-height","calc(100% - 2rem)"),E(r,"width","100%"),I(e,"class","bg-warning position-relative"),E(e,"height","100%"),E(e,"width","100%")},m(c,i){V(c,e,i),g(e,n),g(n,s),g(n,l),g(e,u),g(e,t),g(e,a),g(e,r)},p(c,[i]){i&1&&ne(l,c[0])},i:A,o:A,d(c){c&&h(e)}}}function pe(o,e,n){const s=Math.round(Math.random()*1e10);let{clientCount:l=0}=e,u,t;re(()=>{t=document.getElementById(`canvas-${s}`),u=t.getContext("2d")});function a(c){const i=new Image;i.onload=function(){t.width=i.naturalWidth,t.height=i.naturalHeight,u.drawImage(i,0,0)},i.src=me.exports.decompress(c)}function r(){u.fillStyle="rgb(255, 255, 255)",u.fillRect(0,0,t.width,t.height)}return o.$$set=c=>{"clientCount"in c&&n(0,l=c.clientCount)},[l,s,a,r]}class ve extends j{constructor(e){super(),Q(this,e,pe,ge,X,{clientCount:0,processStream:2,clearStream:3})}get processStream(){return this.$$.ctx[2]}get clearStream(){return this.$$.ctx[3]}}function x(o,e,n){const s=o.slice();return s[18]=e[n],s}function ee(o){let e,n,s=o[18]+"",l,u;return{c(){e=b("option"),n=W("Streamer "),l=W(s),this.h()},l(t){e=C(t,"OPTION",{});var a=$(e);n=H(a,"Streamer "),l=H(a,s),a.forEach(h),this.h()},h(){e.__value=u=o[18],e.value=e.__value},m(t,a){V(t,e,a),g(e,n),g(e,l)},p(t,a){a&32&&s!==(s=t[18]+"")&&ne(l,s),a&32&&u!==(u=t[18])&&(e.__value=u,e.value=e.__value)},d(t){t&&h(e)}}}function be(o){let e,n,s,l,u,t=o[0]!=="-1"&&te(o),a={};return l=new he({props:a}),o[11](l),l.$on("sendChatMessage",o[6]),{c(){e=b("div"),t&&t.c(),n=P(),s=b("div"),K(l.$$.fragment),this.h()},l(r){e=C(r,"DIV",{class:!0,style:!0});var c=$(e);t&&t.l(c),c.forEach(h),n=R(r),s=C(r,"DIV",{class:!0,style:!0});var i=$(s);B(l.$$.fragment,i),i.forEach(h),this.h()},h(){I(e,"class","col-8"),E(e,"padding-right","0"),I(s,"class","col-4"),E(s,"padding-left","0")},m(r,c){V(r,e,c),t&&t.m(e,null),V(r,n,c),V(r,s,c),U(l,s,null),u=!0},p(r,c){r[0]!=="-1"?t?(t.p(r,c),c&1&&M(t,1)):(t=te(r),t.c(),M(t,1),t.m(e,null)):t&&(se(),D(t,1,1,()=>{t=null}),ae());const i={};l.$set(i)},i(r){u||(M(t),M(l.$$.fragment,r),u=!0)},o(r){D(t),D(l.$$.fragment,r),u=!1},d(r){r&&h(e),t&&t.d(),r&&h(n),r&&h(s),o[11](null),G(l)}}}function Ce(o){let e,n;return{c(){e=b("h1"),n=W("Disconnected...")},l(s){e=C(s,"H1",{});var l=$(e);n=H(l,"Disconnected..."),l.forEach(h)},m(s,l){V(s,e,l),g(e,n)},p:A,i:A,o:A,d(s){s&&h(e)}}}function Se(o){let e,n;return{c(){e=b("h1"),n=W("Socket disconnected")},l(s){e=C(s,"H1",{});var l=$(e);n=H(l,"Socket disconnected"),l.forEach(h)},m(s,l){V(s,e,l),g(e,n)},p:A,i:A,o:A,d(s){s&&h(e)}}}function te(o){let e,n,s;function l(t){o[9](t)}let u={};return o[4]!==void 0&&(u.clientCount=o[4]),e=new ve({props:u}),Y.push(()=>de(e,"clientCount",l)),o[10](e),{c(){K(e.$$.fragment)},l(t){B(e.$$.fragment,t)},m(t,a){U(e,t,a),s=!0},p(t,a){const r={};!n&&a&16&&(n=!0,r.clientCount=t[4],fe(()=>n=!1)),e.$set(r)},i(t){s||(M(e.$$.fragment,t),s=!0)},o(t){D(e.$$.fragment,t),s=!1},d(t){o[10](null),G(e,t)}}}function ke(o){let e,n,s,l,u,t,a,r,c,i,S,d=o[5],m=[];for(let f=0;f<d.length;f+=1)m[f]=ee(x(o,d,f));const N=[Se,Ce,be],v=[];function F(f,k){return f[1]===void 0||f[1].readyState!==WebSocket.OPEN?0:f[0]==="-1"?1:2}return a=F(o),r=v[a]=N[a](o),{c(){e=b("div"),n=b("select"),s=b("option"),l=W("Disconnected");for(let f=0;f<m.length;f+=1)m[f].c();u=P(),t=b("div"),r.c(),this.h()},l(f){e=C(f,"DIV",{class:!0,style:!0});var k=$(e);n=C(k,"SELECT",{class:!0,"aria-label":!0});var y=$(n);s=C(y,"OPTION",{});var p=$(s);l=H(p,"Disconnected"),p.forEach(h);for(let w=0;w<m.length;w+=1)m[w].l(y);y.forEach(h),u=R(k),t=C(k,"DIV",{class:!0,style:!0});var _=$(t);r.l(_),_.forEach(h),k.forEach(h),this.h()},h(){s.__value="-1",s.value=s.__value,I(n,"class","form-select"),I(n,"aria-label","Please select a stream..."),o[0]===void 0&&le(()=>o[8].call(n)),I(t,"class","row"),E(t,"height","calc(100% - 2.4rem)"),I(e,"class","col-md-6"),E(e,"height","calc(49vh - 1.5rem)"),E(e,"padding","0")},m(f,k){V(f,e,k),g(e,n),g(n,s),g(s,l);for(let y=0;y<m.length;y+=1)m[y].m(n,null);Z(n,o[0]),g(e,u),g(e,t),v[a].m(t,null),c=!0,i||(S=oe(n,"change",o[8]),i=!0)},p(f,[k]){if(k&32){d=f[5];let p;for(p=0;p<d.length;p+=1){const _=x(f,d,p);m[p]?m[p].p(_,k):(m[p]=ee(_),m[p].c(),m[p].m(n,null))}for(;p<m.length;p+=1)m[p].d(1);m.length=d.length}k&33&&Z(n,f[0]);let y=a;a=F(f),a===y?v[a].p(f,k):(se(),D(v[y],1,1,()=>{v[y]=null}),ae(),r=v[a],r?r.p(f,k):(r=v[a]=N[a](f),r.c()),M(r,1),r.m(t,null))},i(f){c||(M(r),c=!0)},o(f){D(r),c=!1},d(f){f&&h(e),ie(m,f),v[a].d(),i=!1,S()}}}function Ee(o,e,n){let s=J.pki.privateKeyFromPem(z.PRIVATE_KEY),l=J.pki.publicKeyFromPem(z.PUBLIC_KEY),u=0,t="-1",a="",r,c,i,S=!1,d=[],m="";function N(){return!(r===void 0||r.readyState!==WebSocket.OPEN)}const v=()=>{if(!S)return;n(1,r=new WebSocket(`${z.CHATSERVER_URL}`)),n(1,r.onopen=()=>{console.log("[websocket_opened]"),r.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:t,isWatcher:!0,isChatter:!0}))},r),n(1,r.onclose=function(T){n(7,a=""),T.wasClean?console.log(`[websocket_close] Connection closed cleanly, code=${T.code} reason=${T.reason}`):console.log("[websocket_close] Connection died"),setTimeout(v,100)},r),n(1,r.onerror=function(T){console.error(`[websocket_error] ${T.message}`)},r);let _,w,L;n(1,r.onmessage=function(T){const O=JSON.parse(T.data);switch(console.log("[Socket]Incomming:",O.type),O.type){case"CHAT_MESSAGE":_=J.md.sha256.create(),_.update(O.message,"utf8"),w=O.signature,L=l.verify(_.digest().bytes(),w),L&&i.addChat(O);break;case"AVAILABLE_CLIENTS":n(5,d=O.streamerList),console.log("streamerList:",d);break;case"INCOMMING_STREAM":n(4,u=O.clientCount),_=J.md.sha256.create(),_.update(O.frame),w=O.signature,L=l.verify(_.digest().bytes(),w),L&&c.processStream(O.frame);break;case"CONFIRM_CONNECTION":n(7,a=O.streamId);break}},r)};ce(()=>{S=!1,N()&&r.close()}),re(()=>{S=!0,v(),m=_e.getUsername()});async function F(_){const w=_.detail;if(console.log("Sending message: ",w),w==="")return;if(!N()){console.error("Websocket not connected.",r),alert("Chat server connection issue. Check console for more info.");return}let L=J.md.sha256.create();L.update(w,"utf8");let T=s.sign(L);r.send(JSON.stringify({type:"SEND_MESSAGE",sender:m,message:w,signature:T}))}function f(){t=ue(this),n(0,t),n(5,d)}function k(_){u=_,n(4,u)}function y(_){Y[_?"unshift":"push"](()=>{c=_,n(2,c)})}function p(_){Y[_?"unshift":"push"](()=>{i=_,n(3,i)})}return o.$$.update=()=>{o.$$.dirty&143&&N()&&a!==t&&(r.send(JSON.stringify({type:"OPEN_CONNECTION",streamId:t,isWatcher:!0,isChatter:!0})),i&&i.clearChatMessages!==void 0&&i.clearChatMessages(),c&&c.clearStream!==void 0&&c.clearStream())},[t,r,c,i,u,d,F,a,f,k,y,p]}class q extends j{constructor(e){super(),Q(this,e,Ee,ke,X,{})}}function $e(o){let e,n,s,l,u,t,a,r,c,i,S;return s=new q({}),u=new q({}),r=new q({}),i=new q({}),{c(){e=b("div"),n=b("div"),K(s.$$.fragment),l=P(),K(u.$$.fragment),t=P(),a=b("div"),K(r.$$.fragment),c=P(),K(i.$$.fragment),this.h()},l(d){e=C(d,"DIV",{class:!0,style:!0});var m=$(e);n=C(m,"DIV",{class:!0,style:!0});var N=$(n);B(s.$$.fragment,N),l=R(N),B(u.$$.fragment,N),N.forEach(h),t=R(m),a=C(m,"DIV",{class:!0,style:!0});var v=$(a);B(r.$$.fragment,v),c=R(v),B(i.$$.fragment,v),v.forEach(h),m.forEach(h),this.h()},h(){I(n,"class","row"),E(n,"padding","0"),E(n,"margin","0"),I(a,"class","row"),E(a,"padding","0"),E(a,"margin","0"),I(e,"class","row"),E(e,"margin","0")},m(d,m){V(d,e,m),g(e,n),U(s,n,null),g(n,l),U(u,n,null),g(e,t),g(e,a),U(r,a,null),g(a,c),U(i,a,null),S=!0},p:A,i(d){S||(M(s.$$.fragment,d),M(u.$$.fragment,d),M(r.$$.fragment,d),M(i.$$.fragment,d),S=!0)},o(d){D(s.$$.fragment,d),D(u.$$.fragment,d),D(r.$$.fragment,d),D(i.$$.fragment,d),S=!1},d(d){d&&h(e),G(s),G(u),G(r),G(i)}}}class Ne extends j{constructor(e){super(),Q(this,e,null,$e,X,{})}}export{Ne as default};
